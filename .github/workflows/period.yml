name: Update Work Period

on:
  schedule:
    - cron: "0 0 1 * *" # 매월 1일 00:00 UTC 실행
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update periods from markers
        run: |
          TODAY=$(date +%Y-%m-%d)
          TODAY_SEC=$(date -d "$TODAY" +%s)

          FILES=$(grep -rl '<!-- period:' . --include='*.md' || true)

          if [ -z "$FILES" ]; then
            echo "No period markers found"
            exit 0
          fi

          for file in $FILES; do
            grep -oP '<!-- period:\K[0-9]{4}-[0-9]{2}-[0-9]{2}' "$file" | sort -u | while read -r DATE; do
              START_SEC=$(date -d "$DATE" +%s)
              MONTHS=$(( (TODAY_SEC - START_SEC) / 2629743 ))
              YEARS=$((MONTHS / 12))
              REMAINS=$((MONTHS % 12))

              if [ $YEARS -gt 0 ]; then
                PERIOD="${YEARS}년 ${REMAINS}개월차"
              else
                PERIOD="${REMAINS}개월차"
              fi

              sed -i "s|<!-- period:${DATE} -->.*<!-- /period -->|<!-- period:${DATE} -->(${PERIOD})<!-- /period -->|g" "$file"

              echo "$file: $DATE → ($PERIOD)"
            done
          done

      - name: Commit changes
        run: |
          git config --global user.name "anveloper"
          git config --global user.email "90117593+anveloper@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git commit -am "chore: update work period"
            git push
          else
            echo "No changes to commit"
          fi
